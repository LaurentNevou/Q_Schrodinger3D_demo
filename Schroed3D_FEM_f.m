function[E,psi]=Schroed3D_FEM_f(x,y,z,V0,Mass,n)

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Constants %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

h=6.62606896E-34;               %% Planck constant [J.s]
hbar=h/(2*pi);
e=1.602176487E-19;              %% electron charge [C]
m0=9.10938188E-31;              %% electron mass [kg]

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Nx=length(x);
Ny=length(y);
Nz=length(z);

dx=x(2)-x(1);
dy=y(2)-y(1);
dz=z(2)-z(1);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%% Building of the operators %%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Second derivative X %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DX2(Ny=3,Nx=3,Nz=3); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                                                %
%  -2   0   0 | 1   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0  -2   0 | 0   1   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0  -2 | 0   0   1 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   1   0   0 |-2   0   0 | 1   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   1   0 | 0  -2   0 | 0   1   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   1 | 0   0  -2 | 0   0   1 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 1   0   0 |-2   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   1   0 | 0  -2   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   1 | 0   0  -2 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   ===========================================================================================================  %
%   0   0   0 | 0   0   0 | 0   0   0 ||-2   0   0 | 1   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0  -2   0 | 0   1   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0  -2 | 0   0   1 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 1   0   0 |-2   0   0 | 1   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   1   0 | 0  -2   0 | 0   1   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   1 | 0   0  -2 | 0   0   1 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 1   0   0 |-2   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   1   0 | 0  -2   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   1 | 0   0  -2 || 0   0   0 | 0   0   0 | 0   0   0  %
%   ===========================================================================================================  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 ||-2   0   0 | 1   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0  -2   0 | 0   1   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0  -2 | 0   0   1 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 1   0   0 |-2   0   0 | 1   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   1   0 | 0  -2   0 | 0   1   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   1 | 0   0  -2 | 0   0   1  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 1   0   0 |-2   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   1   0 | 0  -2   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   1 | 0   0  -2  %
%                                                                                                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Axy  = [ ones(1,(Nx-1)*Ny) zeros(1,Ny) ];
Axyz = [ repmat(Axy,1,Nz-1) ones(1,(Nx-1)*Ny) ];

DX2 = (-2)*diag(ones(1,Nx*Ny*Nz)) + (1)*diag(Axyz,-Ny) + (1)*diag(Axyz,Ny);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Second derivative Y %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DY2(Ny=3,Nx=3,Nz=3); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                                                %
%  -2   1   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   1  -2   1 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   1  -2 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 |-2   1   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 1  -2   1 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   1  -2 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 |-2   1   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 1  -2   1 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   1  -2 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   ===========================================================================================================  %
%   0   0   0 | 0   0   0 | 0   0   0 ||-2   1   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 1  -2   1 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   1  -2 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 |-2   1   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 1  -2   1 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   1  -2 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 |-2   1   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 1  -2   1 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   1  -2 || 0   0   0 | 0   0   0 | 0   0   0  %
%   ===========================================================================================================  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 ||-2   1   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 1  -2   1 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   1  -2 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 |-2   1   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 1  -2   1 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   1  -2 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 |-2   1   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 1  -2   1  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   1  -2  %
%                                                                                                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

BB=ones(1,Nx*Ny*Nz-1);
BB(Ny:Ny:end)=0;

DY2=(-2)*diag(ones(1,Nx*Ny*Nz)) + (1)*diag(BB,-1) + (1)*diag(BB,1);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% Second derivative Z %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DZ2(Ny=3,Nx=3,Nz=3); %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%                                                                                                                %
%  -2   0   0 | 0   0   0 | 0   0   0 || 1   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0  -2   0 | 0   0   0 | 0   0   0 || 0   1   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0  -2 | 0   0   0 | 0   0   0 || 0   0   1 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 |-2   0   0 | 0   0   0 || 0   0   0 | 1   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0  -2   0 | 0   0   0 || 0   0   0 | 0   1   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0  -2 | 0   0   0 || 0   0   0 | 0   0   1 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 |-2   0   0 || 0   0   0 | 0   0   0 | 1   0   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0  -2   0 || 0   0   0 | 0   0   0 | 0   1   0 || 0   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0  -2 || 0   0   0 | 0   0   0 | 0   0   1 || 0   0   0 | 0   0   0 | 0   0   0  %
%   ===========================================================================================================  %
%   1   0   0 | 0   0   0 | 0   0   0 ||-2   0   0 | 0   0   0 | 0   0   0 || 1   0   0 | 0   0   0 | 0   0   0  %
%   0   1   0 | 0   0   0 | 0   0   0 || 0  -2   0 | 0   0   0 | 0   0   0 || 0   1   0 | 0   0   0 | 0   0   0  %
%   0   0   1 | 0   0   0 | 0   0   0 || 0   0  -2 | 0   0   0 | 0   0   0 || 0   0   1 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 1   0   0 | 0   0   0 || 0   0   0 |-2   0   0 | 0   0   0 || 0   0   0 | 1   0   0 | 0   0   0  %
%   0   0   0 | 0   1   0 | 0   0   0 || 0   0   0 | 0  -2   0 | 0   0   0 || 0   0   0 | 0   1   0 | 0   0   0  %
%   0   0   0 | 0   0   1 | 0   0   0 || 0   0   0 | 0   0  -2 | 0   0   0 || 0   0   0 | 0   0   1 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 1   0   0 || 0   0   0 | 0   0   0 |-2   0   0 || 0   0   0 | 0   0   0 | 1   0   0  %
%   0   0   0 | 0   0   0 | 0   1   0 || 0   0   0 | 0   0   0 | 0  -2   0 || 0   0   0 | 0   0   0 | 0   1   0  %
%   0   0   0 | 0   0   0 | 0   0   1 || 0   0   0 | 0   0   0 | 0   0  -2 || 0   0   0 | 0   0   0 | 0   0   1  %
%   ===========================================================================================================  %
%   0   0   0 | 0   0   0 | 0   0   0 || 1   0   0 | 0   0   0 | 0   0   0 ||-2   0   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   1   0 | 0   0   0 | 0   0   0 || 0  -2   0 | 0   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   1 | 0   0   0 | 0   0   0 || 0   0  -2 | 0   0   0 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 1   0   0 | 0   0   0 || 0   0   0 |-2   0   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   1   0 | 0   0   0 || 0   0   0 | 0  -2   0 | 0   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   1 | 0   0   0 || 0   0   0 | 0   0  -2 | 0   0   0  %
%   -----------------------------------------------------------------------------------------------------------  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 1   0   0 || 0   0   0 | 0   0   0 |-2   0   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   1   0 || 0   0   0 | 0   0   0 | 0  -2   0  %
%   0   0   0 | 0   0   0 | 0   0   0 || 0   0   0 | 0   0   0 | 0   0   1 || 0   0   0 | 0   0   0 | 0   0  -2  %
%                                                                                                                %
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Axyz=ones(1,Nx*Ny*(Nz-1));
DZ2 = (-2)*diag(ones(1,Nx*Ny*Nz)) + (1)*diag(Axyz,-Nx*Ny) + (1)*diag(Axyz,Nx*Ny);

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%% Building of the Hamiltonien %%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

H=(-hbar^2/(2*m0*Mass)) * ( DX2/dx^2 + DY2/dy^2 + DZ2/dz^2 ) +  diag(V0(:)*e) ;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%% Diagonalisation of the Hamiltonien %%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

H=sparse(H);
[PSI,Energy] = eigs(H,n,'SM');
E = diag(Energy)/e;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%% Normalization of the Wavefunction %%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

for i=1:n
    psi_temp=reshape(PSI(:,i),Ny,Nx,Nz);
    %psi(:,:,:,i) = psi_temp / sqrt( trapz(z,trapz( y' , trapz(x,abs(psi_temp).^2 ,2) , 1 ),3)  );  % normalisation of the wave function psi
    psi(:,:,:,i) = psi_temp / max(psi_temp(:));
end

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% here is a small patch due to differences between Octave and Matlab
% Matlab order the eigen values while Octave reverse it

if E(1)>E(2)
  psi=psi(:,:,:,end:-1:1);
  E=E(end:-1:1);
end

end
